---
title: "Planned Analyses"
author: "Elisabeth Nelson"
date: "2022-10-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(readr)
pacman::p_load(
  lubridate,  # general package for handling and converting dates  
  linelist,   # has function to "guess" messy dates
  aweek,      # another option for converting dates to weeks, and weeks to dates
  zoo,        # additional date/time functions
  tidyverse,  # data management and visualization  
  rio, #importing data
  here, #relative file pathways
  janitor, #data cleaning and tables
  epikit) #ag_categories function
library(ggplot2)
library(stats); library(splines); library(gam); library(dlnm)
library(scales)
library(patchwork)
library(survival)
library(plotly)

```


## Species Density vs. Climate
```{r}

#	number of mosquitoes by trap due to weather  Poisson
#	Looking at phenology of the mosquito and seasonal dynamics in relation to weather variables to understand 
#	entomological indices of risk in relation to weather variables 
#	vs. WNV positivity (as a function of number caught, seasonality)

species_table <- core_traps_ff %>%
  select(Species, Date, X..Mosquitoes) %>%
  rename("species" = Species, 
         "date" = Date, 
         "num_caught" =  X..Mosquitoes)

species_by_year <- species_table %>%
  group_by(species) %>%
  summarize(num_caught = sum(num_caught))

species_by_year %>%
ggplot(aes(x = species, y = num_caught))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))

#ggplot(trap_climate)+
  #geom_line(aes(Date, tmean))
  #geom_line(aes(Date, tmin), col = "blue")+
  #geom_line(aes(Date, tmax), col = "red")+
 # theme_classic()+
 # labs(x = "Date", y = "Temperature (F)", title = "Temperature at Trap Locations")


# plotting one site's temp and number caught
by_site_mozzies <- core_traps_ff %>%
  filter(Site == "BB17") %>%
  group_by(Date) %>%
  summarize(total_caught_by_day = sum(X..Mosquitoes))

by_site_climate <- trap_climate %>%
  filter(Name == "BB17") %>%
  group_by(Date)

by_site_climate_mozzie <- left_join()

# side-by-side graphs
p1 <- ggplot()+
  geom_line(data = by_site_climate, aes(x = Date, y = tmean), col = "red")

p2 <- ggplot()+
  geom_line(data = by_site_mozzies, aes(x = Date, y = log(total_caught_by_day)))

p1 + p2

#combined plot
coeff <- 10
    #mean temp
ggplot()+
  geom_line(data = by_site_climate, aes(x = Date, y = tmean), col = "red")+
  geom_line(data = by_site_mozzies, aes(x = Date, y = log(total_caught_by_day)*coeff))+ 
  scale_y_continuous(name = "Mean Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log scale)"))+
  theme_classic()
    # min temp
ggplot()+
  geom_line(data = by_site_climate, aes(x = Date, y = tmin), col = "red")+
  geom_line(data = by_site_mozzies, aes(x = Date, y = log(total_caught_by_day)*coeff))+ 
  scale_y_continuous(name = "Min Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log scale)"))+
  theme_classic()
    # max temp
ggplot()+
  geom_line(data = by_site_climate, aes(x = Date, y = tmax), col = "red")+
  geom_line(data = by_site_mozzies, aes(x = Date, y = log(total_caught_by_day)*coeff))+ 
  scale_y_continuous(name = "Max Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log scale)"))+
  theme_classic()
    # dew point
ggplot()+
  geom_line(data = by_site_climate, aes(x = Date, y = tdmean), col = "purple")+
  geom_line(data = by_site_mozzies, aes(x = Date, y = log(total_caught_by_day)*coeff))+ 
  scale_y_continuous(name = "Mean Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log scale)"))+
  theme_classic()
    # precipitation
p3 <- ggplot()+
  geom_line(data = by_site_climate, aes(x = Date, y = ppt), col = "blue")

p2 + p3

coeff_2 <- 100
ggplot()+
  geom_line(data = by_site_mozzies, aes(x = Date, y = log(total_caught_by_day)))+ 
  geom_line(data = by_site_climate, aes(x = Date, y = ppt*coeff_2), col = "blue")+
  scale_y_continuous(name = "Total Mosquitoes Caught (log scale)", sec.axis = sec_axis(~./coeff_2, name = "Precipitation (in)"))+
  theme_classic()

```

## First WNV Positive and Predictors 
```{r}
#	Descriptive stats (survival model) --> first day of WNV each year 
#	Days since June 1st (don’t start trapping on the same day every year)
#	Weather
#	Spatial shift between sites/state

# create a new column of days since June 1st for 1st WNV+, do for overall, cx pipiens, and cx restuans
core_traps_ff_WNV <- core_traps_ff %>%
  mutate(WNV_pos = case_when(Virus == "WNV" ~ 1,
                             Virus == "WNV, HJ" ~ 1, 
                             Virus == "WNV & HJ" ~ 1,
                             Virus == "EEE & WNV" ~ 1,
                             Virus != "WNV" ~ 0)) %>%
  filter(WNV_pos == 1)

core_traps_ff_WNV <- core_traps_ff_WNV %>%
  arrange(Site, Species, Date) %>%
  mutate(year = year(Date)) %>%
  group_by(Site,Species, year) %>%
  mutate(june_1 = "June-01") %>%
  unite("june1", year:june_1, remove = F) %>%
  mutate(june1 = as.Date(june1, "%Y_%b-%d"),
         sampleN=row_number(),
        days_since_june_1 = as.numeric(Date - june1))

core_traps_ff_WNV_first <- core_traps_ff_WNV %>%
  arrange(Site,Species, year) %>%
  group_by(Site,Species, year) %>%
  filter(row_number() == 1)

ggplot(core_traps_ff_WNV_first, aes(Date, days_since_june_1), na.rm = T)+
  geom_line()+
  theme_classic()

ggplot(core_traps_ff_WNV_first, aes(Date, days_since_june_1, col = Species), na.rm = T)+
  geom_line()+
  theme_classic()
  #facet_wrap(~Site)

core_traps_ff_WNV_first %>%
  filter(Species == "culex pipiens" | Species == "culex restuans") %>%
  ggplot(aes(Date, days_since_june_1, col = Species), na.rm = T)+
  geom_line()+
  theme_classic()

core_traps_ff_WNV_first %>%
  filter(Species == "culex pipiens" | Species == "culex restuans") %>%
  ggplot(aes(Date, days_since_june_1, col = Species), na.rm = T)+
  geom_line()+
  geom_smooth()+
  facet_wrap(~Species)+
  theme_classic()

core_traps_ff_WNV_first %>%
  filter(Species == "culex pipiens" | Species == "culex restuans") %>%
  ggplot(aes(Date, days_since_june_1, col = Species), na.rm = T)+
  geom_line()+
  geom_point(aes(col = Site))+
  facet_wrap(~Species)+
  theme_classic()

core_traps_ff_WNV_first %>%
  filter(Species == "culex pipiens" | Species == "culex restuans") %>%
  ggplot(aes(Date, days_since_june_1, col = Site), na.rm = T)+
  geom_line()+
  facet_wrap(~Species)+
  theme_classic()

## Map
core_traps_ff_WNV_first <- core_traps_ff_WNV_first %>%
  mutate(Site = as.character(Site))

WNV_first_map <- left_join(core_traps_ff_WNV_first, trap_locations, by = c("Site" = "Location")) %>%
  ungroup


ggplot()+
  geom_polygon(data=CT_2, aes(x=long, y=lat, group=group), fill=NA, colour='black', alpha=0)+
  geom_point(data = WNV_first_map, aes(x = Longitude, y = Latitude, group = factor(days_since_june_1), col = days_since_june_1, size = days_since_june_1))+
  scale_color_distiller(name = "Days Since June 1st", 
                       palette = "Blues", 
                       direction = 1)+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA))

# average days per year
WNV_avg_first <- WNV_first_map %>%
  group_by(year(Date)) %>%
  summarize(avg_days_since = mean(days_since_june_1)) %>%
  rename("year" = "year(Date)")
  
ggplot(WNV_avg_first, aes(x = year, y = avg_days_since))+
  geom_line()+
  geom_point()+
  geom_smooth()+
  theme_classic()+
  labs(x = "Year", y = "Days Since June 1", title = "Average Days Until First WNV Positive Since June 1")

############ Survival Model ##############
# time, positive, num_caught, log_temp (2, 4, 6, 8 weeks), land-use
survival_table <- core_traps_ff_WNV_first %>%
  select(Species, Site, Date, X..Mosquitoes, Virus, days_since_june_1)
trap_land_cover <- trap_location_land_cover %>%
  select(Location, Type.of.Collection.Site, updated_land_cover)
survival_climate <- trap_climate_with_lag %>%
  select(Name, ppt, tmean, tdmean, lag_2_tmean, lag_4_tmean, lag_6_tmean, lag_8_tmean)
  
survival_table<- left_join(survival_table, trap_land_cover, by = c("Site" = "Location"))
survival_table <- left_join(survival_table, survival_climate, by = c("Site" = "Name"))

## basic survival model
  # use core_traps_ff_WNV (days since June 1) and core_traps_ff_WNV_first (days since June 1, only first of the year)
core_traps_ff_surv <- core_traps_ff 
  mutate(WNV_pos = case_when(Virus == "WNV" ~ 1,
                             Virus == "WNV, HJ" ~ 1, 
                             Virus == "WNV & HJ" ~ 1,
                             Virus == "EEE & WNV" ~ 1,
                             Virus != "WNV" ~ 0)) 
core_traps_ff_surv <- core_traps_ff_surv %>%
  arrange(Site, Species, Date) %>%
  mutate(year = year(Date)) %>%
  group_by(Site,Species, year) %>%
  mutate(june_1 = "June-01") %>%
  unite("june1", year:june_1, remove = F) %>%
  mutate(june1 = as.Date(june1, "%Y_%b-%d"),
         sampleN=row_number(),
        days_since_june_1 = as.numeric(Date - june1))
core_traps_ff_surv_1 <- core_traps_ff_surv %>%
  arrange(Site,Species, year) %>%
  group_by(Site,Species, year) %>%
  filter(row_number() == 1)

survobj <- Surv(time = core_traps_ff_surv_1$days_since_june_1, 
                    event = core_traps_ff_surv_1$WNV_pos)
surv_fit <- survfit(survobj ~ 1)
plot(surv_fit, 
     xlab = "Days Since June 1", 
     ylab = "WNV Probability", 
     main = "First WNV Positive Survival Curve")

## cox model to assess the effect of updated land cover and lag 2 tmean

surv_cox_landcov_lag2temp <- coxph(
  Surv(days_since_june_1, WNV_pos) ~ updated_land_cover + lag_2_tmean, 
  data = core_traps_ff_surv_1
)
summary(surv_cox_landcov_lag2temp)

## for pipiens
cxp_surv <- core_traps_ff_surv_1 %>%
  dplyr::filter(Species == "culex pipiens")

survobj_cxp <- Surv(time = cxp_surv$days_since_june_1, 
                    event = cxp_surv$WNV_pos)
surv_fit_cxp <- survfit(survobj_cxp ~ 1)
plot(surv_fit_cxp, 
     xlab = "Days Since June 1", 
     ylab = "WNV Probability", 
     main = "Culex Pipiens First WNV Positive Survival Curve")

## for restuans
cxr_surv <- core_traps_ff_surv_1 %>%
  dplyr::filter(Species == "culex restuans")

survobj_cxr <- Surv(time = cxr_surv$days_since_june_1, 
                    event = cxr_surv$WNV_pos)
surv_fit_cxr <- survfit(survobj_cxr ~ 1)
plot(surv_fit_cxr, 
     xlab = "Days Since June 1", 
     ylab = "WNV Probability", 
     main = "Culex Restuans First WNV Positive Survival Curve")

```
No clear trend in days since June 1 for first positive for totals or species-specific. What statistical analysis should I do? 

as josh for model
survival model --> failure time is the date of first positive


## Culex pipiens populations vs. WNV activity
```{r}
#	Longitudinal analysis 
#	Growth curve 

# abundance bar plot
culex_pipiens <- core_traps_ff %>%
  filter(Species == "culex pipiens") %>%
  group_by(year(Date)) %>%
  mutate(year_total = sum(X..Mosquitoes))

culex_pipiens %>%
ggplot(aes(x = year(Date), y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  theme_classic()

# abundance plot
core_traps_ff %>%
  filter(Species == "culex pipiens") %>%
  group_by(year(Date)) %>%
  mutate(year_total = sum(X..Mosquitoes)) %>%
  ggplot(aes(x = year(Date), y = year_total))+
    geom_line(color = "blue")+
    #facet_wrap(~species, scales = 'free_y')+
    theme_classic()

core_traps_ff %>%
  filter(Species == "culex pipiens") %>%
  ggplot(aes(x = Date, y = X..Mosquitoes, group = Site))+
    geom_line(aes(col = Site))+
    facet_wrap(~ Site)+
    theme_classic()
    

############# plot over CT map  #############
cxp_map <- culex_pipiens%>%
  mutate(Site = as.character(Site))

cxp_map <- left_join(cxp_map, trap_locations, by = c("Site" = "Location")) %>%
  ungroup
 

ggplot()+
  geom_polygon(data=CT_2, aes(x=long, y=lat, group=group), fill=NA, colour='black', alpha=0)+
  geom_point(data = cxp_map, aes(x = Longitude, y = Latitude, group = factor(Site), size = X..Mosquitoes), alpha = 0.05, col = "blue")+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA))


# scales by area


############ population vs. climate ############
core_traps_ff_cxp <- core_traps_ff %>%
  filter(Species == "culex pipiens")

# NOT USING  = try plotting in 5 year increments
cxp_2001_2006 <- core_traps_ff_cxp %>%
  filter(Date >= '2001-01-01' & Date <= '2006-12-31') %>%
  group_by(Site)
 # looks very funky
ggplot()+
  geom_point(data = cxp_2001_2006, aes(x = Date, y = X..Mosquitoes))

### actually worked: 

cxp_2001_2021 <- core_traps_ff_cxp %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes),
         avg_daily_temp = mean(tmean),
         avg_min_daily_temp = mean(tmin), 
         avg_max_daily_temp = mean(tmax), 
         avg_dewpoint_daily_temp = mean(tdmean))

par(mfrow = c(2, 2))

coeff <- 10

ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_daily_temp), col = "orange")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Mean Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_min_daily_temp), col = "yellow")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Min Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Min Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_max_daily_temp), col = "red")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Max Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Max Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_dewpoint_daily_temp), col = "blue")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Mean Dewpoint Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

# shown side-by-side
cxp3 <- ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_daily_temp), col = "orange")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Mean Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxp4 <- ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_min_daily_temp), col = "yellow")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Min Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Min Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxp5 <- ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_max_daily_temp), col = "red")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Max Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Max Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxp6 <- ggplot(data = cxp_2001_2021)+
  geom_line(aes(x = Date, y = avg_dewpoint_daily_temp), col = "blue")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens Trap Catches vs. Mean Dewpoint Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxp3 + cxp4 + cxp5 + cxp6
```
Needed to average across traps (so across the state) to just plot climate vs. Cx. pipiens abundance...
Should I do a GAM or GLM????

## Culex restuans populations vs. WNV activity
```{r}

#	Longitudinal analysis 
#	Growth curve 

# abundance bar plot
culex_restuans <- core_traps_ff %>%
  filter(Species == "culex restuans") %>%
  group_by(year(Date)) %>%
  mutate(year_total = sum(X..Mosquitoes))

core_traps_ff %>%
  filter(Species == "culex restuans") %>%
  group_by(year(Date)) %>%
  mutate(year_total = sum(X..Mosquitoes)) %>%
ggplot(aes(x = year(Date), y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  theme_classic()

# abundance plot
core_traps_ff %>%
  filter(Species == "culex restuans") %>%
  group_by(year(Date)) %>%
  mutate(year_total = sum(X..Mosquitoes)) %>%
  ggplot(aes(x = year(Date), y = year_total))+
    geom_line(color = "blue")+
    #facet_wrap(~species, scales = 'free_y')+
    theme_classic()

core_traps_ff %>%
  filter(Species == "culex restuans") %>%
  ggplot(aes(x = Date, y = X..Mosquitoes, group = Site))+
    geom_line(aes(col = Site))+
    facet_wrap(~ Site)+
    theme_classic()
    

# plot over CT map 
cxr_map <- culex_restuans%>%
  mutate(Site = as.character(Site))

cxr_map <- left_join(cxr_map, trap_locations, by = c("Site" = "Location")) %>%
  ungroup
  

ggplot()+
  geom_polygon(data=CT_2, aes(x=long, y=lat, group=group), fill=NA, colour='black', alpha=0)+
  geom_point(data = cxr_map, aes(x = Longitude, y = Latitude, group = factor(Site), size = X..Mosquitoes ), alpha = 0.05, col = "red")+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA))

###### Population vs. Climate #########
core_traps_ff_cxr <- core_traps_ff %>%
  filter(Species == "culex restuans")

cxr_2001_2021 <- core_traps_ff_cxr %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes),
         avg_daily_temp = mean(tmean),
         avg_min_daily_temp = mean(tmin), 
         avg_max_daily_temp = mean(tmax), 
         avg_dewpoint_daily_temp = mean(tdmean))

par(mfrow = c(2, 2))

coeff <- 10

ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_daily_temp), col = "orange")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Mean Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_min_daily_temp), col = "yellow")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Min Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Min Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_max_daily_temp), col = "red")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Max Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Max Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_dewpoint_daily_temp), col = "blue")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Mean Dewpoint Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

# shown side-by-side
cxr3 <- ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_daily_temp), col = "orange")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Mean Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxr4 <- ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_min_daily_temp), col = "yellow")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Min Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Min Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxr5 <- ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_max_daily_temp), col = "red")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Max Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Max Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxr6 <- ggplot(data = cxr_2001_2021)+
  geom_line(aes(x = Date, y = avg_dewpoint_daily_temp), col = "blue")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Restuans Trap Catches vs. Mean Dewpoint Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cxr3 + cxr4 + cxr5 + cxr6


```

## Model the two species together (Cx. pipiens + Cx. restuans)
```{r}
#	leverage habitat correlation 
#	How does land use affect?


cxp_cxr_table <- species_table %>%
  mutate(species = as.character(species)) %>%
  filter(species == "culex pipiens" | species == "culex restuans") %>%
  group_by(species, year(date)) %>%
  mutate(year_total = sum(num_caught))

ggplot(cxp_cxr_table, aes(x = year(date), y = year_total, group = species, col = species ))+
  geom_line()+
  #facet_wrap(~species, scales = 'free_y')+
  theme_classic()

cxp_cxr_table %>%
  mutate(Site = as.character(Site))

cxp_cxr_climate <- left_join(cxp_cxr_table, trap_climate, by = c("Site" = "Name", "date" = "Date"))

str(cxp_cxr_map)

#cxp_cxr_table %>%
#  ggplot(aes(x = date, y = `tmean (degrees F)`))+
#  geom_line()+
#  theme_classic()

## MAP
cxp_cxr_map <- left_join(cxp_cxr_table, trap_locations, by = c("Site" = "Location")) %>%
  ungroup 

cxp_cxr_map <- cxp_cxr_map %>%
  mutate(num_caught = as.numeric(num_caught))

ggplot()+
  geom_polygon(data = CT_2, aes(x=long, y=lat, group=group), fill=NA, colour='black', alpha=0)+
  geom_point(data = cxp_cxr_map, aes(x = Longitude, y = Latitude, group = factor(Site), col = factor(species), size = num_caught), alpha = 0.05)+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA))


###### Population vs. Climate ########
core_traps_ff_cx <- core_traps_ff %>%
  filter(Species == "culex restuans" | Species == "culex pipens")

### actually worked: 

cx_2001_2021 <- core_traps_ff_cx %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes),
         avg_daily_temp = mean(tmean),
         avg_min_daily_temp = mean(tmin), 
         avg_max_daily_temp = mean(tmax), 
         avg_dewpoint_daily_temp = mean(tdmean))

par(mfrow = c(2, 2))

coeff <- 10

ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_daily_temp), col = "orange")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Mean Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_min_daily_temp), col = "yellow")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Min Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Min Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_max_daily_temp), col = "red")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Max Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Max Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_dewpoint_daily_temp), col = "blue")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Mean Dewpoint Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

# shown side-by-side
cx3 <- ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_daily_temp), col = "orange")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Mean Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cx4 <- ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_min_daily_temp), col = "yellow")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Min Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Min Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cx5 <- ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_max_daily_temp), col = "red")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Max Daily Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Max Daily Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cx6 <- ggplot(data = cx_2001_2021)+
  geom_line(aes(x = Date, y = avg_dewpoint_daily_temp), col = "blue")+
  geom_line(aes(x = Date, y = log10(total_caught_daily)*coeff))+
    scale_y_continuous(name = "Mean Daily Dewpoint Temperature (F)", sec.axis = sec_axis(~./coeff, name = "Total Mosquitoes Caught (log10 scale)"))+
  labs(title = "Culex Pipiens & Restuans Trap Catches vs. Mean Dewpoint Temperature 2001-2021", subtitle = "Across all 87 traps")+
  theme_classic()

cx3 + cx4 + cx5 + cx6



```

## Seasonality 
```{r}

# Shifting of transmission season?
#	Lengthening of the transmission season? 
#	Does it result in a longer virus transmission season? 
#	Culex overwinter as adults (only females, mated), how is climate change affecting these population dynamics and what does that mean for WNV risk?
#	Interannual variation: amplitude and duration of transmission period
#	Timing and length of transmission and how that varies over time, then work backwards to see how that relates to climate data
#	Timing and duration of virus activity


```

## Effect of Extreme Weather
```{r}

# need to define extreme weather

```

## How do entomological indices and WNV positivity relate to human cases? 
```{r}
# Model proportion of each species that is positive and then use it as a human predictor

```

# If you were to put another trap, where would you want to place it?
```{r}
# more in total or more of a certain species caught?
# what are you trying to optimize? 
```
