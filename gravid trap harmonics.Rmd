---
title: "Gravid Trap Harmonics"
author: "Elisabeth Nelson"
date: "2023-02-06"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(readr)
pacman::p_load(
  lubridate,  # general package for handling and converting dates  
  linelist,   # has function to "guess" messy dates
  aweek,      # another option for converting dates to weeks, and weeks to dates
  zoo,        # additional date/time functions
  tidyverse,  # data management and visualization  
  rio, #importing data
  here, #relative file pathways
  janitor, #data cleaning and tables
  epikit) #ag_categories function
library(ggplot2)
library(stats); library(splines); library(gam); library(dlnm)
library(scales)
library(patchwork)
library(survival)
library(plotly)
library(survminer)
library(MASS)

```


## Just Cx. pipiens
```{r}

####### data set up #############
# aggregate trap data into weeks
cxp_2001_2021_g <- core_traps_ff_gravid %>%
  filter(Species == "culex pipiens") %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes))

cxp_harmonics_g <- cxp_2001_2021_g %>%
  dplyr::select(Date, total_caught_daily) %>%
  group_by(Date) %>%
  dplyr::mutate(caught_daily = sum(total_caught_daily)) %>%
  distinct(Date, .keep_all = T)
  
cxp_harmonics_1_g <- cxp_harmonics_g %>%
  dplyr::select(Date, caught_daily) %>%
  group_by(Date) %>%
  mutate(week_date = floor_date(Date, "week")) %>%
  group_by(week_date) %>%
  summarize(caught_daily = sum(caught_daily)) %>%
  tidyr::complete(week_date = seq.Date(from=min(week_date), to=max(week_date), by='week'), fill=list(caught_daily=0)) %>%
   mutate(week = as.factor(lubridate::week(week_date)), 
         year = as.factor(lubridate::year(week_date)))

# aggregate climate data into weeks
weekly_trap_climate_lag <- trap_climate_with_lag %>%
  group_by(Date) %>%
  mutate(week = week(Date), 
         year = year(Date)) %>%
  group_by(year, week) %>%
  summarize(weekly_ppt = sum(ppt), 
         weekly_avg_tmin = mean(tmin), 
         weekly_avg_tmean = mean(tmean), 
         weekly_avg_tmax = mean(tmax), 
         weekly_avg_tdmean = mean(tdmean), 
         weekly_avg_lag2_tmean = mean(lag_2_tmean), 
         weekly_avg_lag4_tmean = mean(lag_4_tmean), 
         weekly_avg_lag6_tmean = mean(lag_6_tmean), 
         weekly_avg_lag8_tmean = mean(lag_8_tmean), 
         weekly_lag2_ppt = sum(lag_2_ppt), 
         weekly_lag4_ppt = sum(lag_4_ppt), 
         weekly_lag6_ppt = sum(lag_6_ppt), 
         weekly_lag8_ppt = sum(lag_8_ppt)) %>%
  mutate(week = as.factor(week), 
         year = as.factor(year))

# join climate and trap data
cxp_harmonics_climate_g <- left_join(cxp_harmonics_1_g, weekly_trap_climate_lag, by = c("year" = "year", "week" = "week"))
cxp_harmonics_climate_g <- cxp_harmonics_climate_g %>%
  mutate(log_caught = log(caught_daily)) 
cxp_harmonics_climate_g$log_caught[is.infinite(cxp_harmonics_climate_g$log_caught)] <- 0


# plot number against time 
ggplot(data = cxp_harmonics_climate_g)+
  geom_line(aes(week_date, caught_daily))+
  xlab("Time")+
  ylab("Culex pipiens caught")+
  theme_classic()

ggplot(data = cxp_harmonics_climate_g)+
  geom_line(aes(week_date, log_caught))+
  ylim(-5, 15)+
  xlab("Time")+
  ylab("Culex pipiens caught")+
  theme_classic()

# Fast fourier transform
tmax <- length(cxp_harmonics_climate_g$caught_daily) # number of weeks
dt <- 1/52 # time step in years
ym <- abs(fft(cxp_harmonics_climate_g$log_caught)) # absolute value of the power from FFT
f <- (0:(tmax - 1))/tmax # frequency of oscillations (in weeks)
period <- dt/f # period of oscillations (in years) = 1/frequency

plot(x=period[2:round(tmax/2)+1], y=ym[2:round(tmax/2)+1], 
     type='h', xlim=c(0,12),bty="l",
     xlab='Period (years)', ylab='Strength', 
     main="Absolute value of the power from FFT")

order(ym[2:round(tmax/2)+1], decreasing = T)[1:3] # dominate periods of oscillations --> 19, 20, 40
period[2:round(tmax/2)+1][19] # 1.022115 years
period[2:round(tmax/2)+1][20] # 0.9734432
period[2:round(tmax/2)+1][40] # 0.4985929

######### Dan's method #########
## generate harmonic curves
cxp_harmonics_climate_g <- cxp_harmonics_climate_g %>%
  arrange(week_date) %>%
  mutate(t = row_number())

# dominant periods = 53 weeks (1.022115 years), 51 weeks (0.9734432 years), and
# 26 weeks (0.4985929 years) --> 52/#

cxp_harmonics_climate_2_g <- cxp_harmonics_climate_g %>%
  mutate(sin53 = sin(2*pi*t*0.9783635/52.143), 
         cos53 = cos(2*pi*t*0.97836355/52.143), 
         sin51 = sin(2*pi*t*1.027281/52.143), 
         cos51 = cos(2*pi*t*1.027281/52.143), 
         sin26 = sin(2*pi*t*2/52.143), 
         cos26 = cos(2*pi*t*2/52.143), 
         sin52 = sin(2*pi*t/52.143),
         cos52 = cos(2*pi*t/52.143))

#### fit neg binomial regression models 

# 52 + 26 week oscillations 
fit2 <- glm.nb(log_caught ~ sin52 + cos52 + sin26 + cos26, data = cxp_harmonics_climate_2_g)
cxp_harmonics_climate_2_g$pred2<- fitted(fit2)

ggplot(cxp_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred2), color = "red")+
  ylab("Culex pipiens caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxp_harmonics_climate_2_g, aes(week_date, exp(log_caught)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred2)), color = "red")+
  ylab("Culex pipiens caught")+
  xlab("Time")+
  theme_classic()

# 53, 51, and 26  week oscillations --> doesn't fit well
fit4 <- glm.nb(log_caught ~ sin53 + cos53 + sin51 + cos51 + sin26 + cos26, data = cxp_harmonics_climate_2_g)
cxp_harmonics_climate_2_g$pred4<- fitted(fit4)

ggplot(cxp_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "gray")+
  geom_line(aes(week_date, pred4), color = "red")+
  theme_classic()

# try just a 52 week oscillation 
fit5 <- glm.nb(log_caught ~ sin52 + cos52, data = cxp_harmonics_climate_2_g)
cxp_harmonics_climate_2_g$pred5<- fitted(fit5)

ggplot(cxp_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred5), color = "red")+
  ylab("Culex pipiens caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxp_harmonics_climate_2_g, aes(week_date, exp(log_caught)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred5)), color = "red")+
  ylab("Culex pipiens and restuans caught")+
  xlab("Time")+
  theme_classic()

# determine better model 
AIC(fit4)
AIC(fit5)
AIC(fit2)
BIC(fit4)
BIC(fit5)
BIC(fit2) # best fit

### calculate amplitude of 52 week period
# pull coefs out of results of model
beta_sin52<-coef(fit5)['sin52']
beta_cos52<-coef(fit5)['cos52']

amp52<-sqrt(beta_sin52^2 +beta_cos52^2)
amp52 # 2.940764

#### run wavelet analysis 
source(file="/Users/zoe/Documents/Yale EMD/Year 1/Quantitative Methods in Infectious Disease Epidemiology/Lab/WaveletPkg.R")
# mozzies caught
wave1 <- cxp_harmonics_climate_2_g %>% 
    mutate(x = sqrt(caught_daily)) %>% # makes everything behave better and closer to guassian signal
   dplyr::select(x, t)

cwt1 <- complete.cwt(wave1, dj=1/26, dt=1/52)

plot.cwt(cwt1) # plots the wavelet with the power spectrum


# precipitation
wave2 <- cxp_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_ppt)) %>%
   dplyr::select(x, t)
cwt2 <- complete.cwt(wave2, dj=1/26, dt=1/52)
plot.cwt(cwt2)
# tmin
wave3 <- cxp_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_avg_tmin)) %>% 
   dplyr::select(x, t)
cwt3 <- complete.cwt(wave3, dj=1/26, dt=1/52)
plot.cwt(cwt3)
# tmean
wave4 <- cxp_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_avg_tmean)) %>% 
   dplyr::select(x, t)
cwt4 <- complete.cwt(wave4, dj=1/26, dt=1/52)
plot.cwt(cwt4)
# tmax
wave5 <- cxp_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_avg_tmax)) %>% 
   dplyr::select(x, t)
cwt5 <- complete.cwt(wave5, dj=1/26, dt=1/52)
plot.cwt(cwt5)
# tdmean --> doesn't work
#wave6 <- cxp_harmonics_climate_2 %>% 
#    mutate(x=sqrt(weekly_avg_tdmean)) %>% 
#   dplyr::select(x, t)
#cwt6 <- complete.cwt(wave6, dj=1/26, dt=1/52)
#plot.cwt(cwt6)

```

```{r}

#### Calculate Phase angles 
phase1 <- phase(cwt1, s=c(0.8, 1.2)) # pulls out the phase for whatever period you're looking at
phase2 <- phase(cwt2, s=c(0.8, 1.2))
phase3 <- phase(cwt3, s=c(0.8, 1.2))
phase4 <- phase(cwt4, s=c(0.8, 1.2))
phase5 <- phase(cwt5, s=c(0.8, 1.2))
#phase6 <- phase(cwt6, s=c(0.8, 1.2))

dates <- unique(cxp_harmonics_climate_2_g$week_date)
plot(dates, phase1,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # cx. pipiens
points(dates, phase2,type='l', col="light blue", lty=1) # ppt
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

plot(dates, phase1,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") 
points(dates, phase3,type='l', col="pink", lty=1) # tmin
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

plot(dates, phase1,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians")
points(dates, phase4,type='l', col="orange", lty=1) # tmean
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

plot(dates, phase1,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians")
points(dates, phase5,type='l', col="goldenrod3", lty=1) # tmax
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

#### Calculate and plot phase differences
#Take modulo (%%) of phase difference to account for edge effects as described by Grenfell. This corrects for problems at start and begining of cycles
phase.diff2.1 = phase2 - phase1 #ppt
phase.diff3.1 = phase3 - phase1 #tmin
phase.diff4.1 = phase4 - phase1 #tmean
phase.diff5.1 = phase5 - phase1 #tmax

phasediff2.1_correct <- ((phase.diff2.1 + 3*pi) %% (2*pi)) - (pi) #ppt
phasediff3.1_correct <- ((phase.diff3.1 + 3*pi) %% (2*pi)) - (pi) #tmin
phasediff4.1_correct <- ((phase.diff4.1 + 3*pi) %% (2*pi)) - (pi) #tmean
phasediff5.1_correct <- ((phase.diff5.1 + 3*pi) %% (2*pi)) - (pi) #tmax
	#shows corrected phase diff in modulo for the 12 month phase
	# corrects for how things get wonky at the edge of sawtooth (end of each year)

plot(dates,phasediff2.1_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #ppt
plot(dates,phasediff3.1_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmin
plot(dates,phasediff4.1_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmean
plot(dates,phasediff5.1_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmax
	
### convert from radians to weeks
#ppt
phase.diff.wk2 <- phasediff2.1_correct * 52.143/(2*pi)
plot(dates,phase.diff.wk2,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

#tmin
phase.diff.wk3 <- phasediff3.1_correct * 52.143/(2*pi)
plot(dates,phase.diff.wk3,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

#tmean
phase.diff.wk4 <- phasediff4.1_correct * 52.143/(2*pi)
plot(dates,phase.diff.wk4,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

#tmax
phase.diff.wk5 <- phasediff5.1_correct * 52.143/(2*pi)
plot(dates,phase.diff.wk5,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = dates[53], lty = 6, col = "red")
abline(v = dates[73], lty = 6, col = "red")
abline(v = dates[157], lty = 6, col = "red")
abline(v = dates[176], lty = 6, col = "red")
abline(v = dates[261], lty = 6, col = "red")
abline(v = dates[282], lty = 6, col = "red")
abline(v = dates[314], lty = 6, col = "red")
abline(v = dates[333], lty = 6, col = "red")
abline(v = dates[522], lty = 6, col = "red")
abline(v = dates[541], lty = 6, col = "red")

```


## Cx. pipiens Coherence analysis --> At which periodicity do we have correlation?

periods and which time points are the series in sync? should actually use more monte carlo draws, but takes too long for in class demo (note if set dt=1/52, gives same result but takes much longer)

```{r coherence}
#ppt
coh1.2 <- complete.coh(wave1,wave2, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.2)

# tmin
coh1.3 <- complete.coh(wave1,wave3, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.3)

# tmean
coh1.4 <- complete.coh(wave1,wave4, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.4)

# tmax
coh1.5 <- complete.coh(wave1,wave5, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.5)


```

### Just cx. restuans 
```{r}
####### data set up #############
# aggregate trap data into weeks
core_traps_ff_cxr_g <- core_traps_ff_gravid %>%
  filter(Species == "culex restuans")

cxr_2001_2021_g <- core_traps_ff_cxr_g %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes))

cxr_harmonics_g <- cxr_2001_2021_g %>%
  dplyr::select(Date, total_caught_daily) %>%
  group_by(Date) %>%
  dplyr::mutate(caught_daily = sum(total_caught_daily)) %>%
  distinct(Date, .keep_all = T)
  
cxr_harmonics_1_g <- cxr_harmonics_g %>%
  dplyr::select(Date, caught_daily) %>%
  group_by(Date) %>%
  mutate(week_date = floor_date(Date, "week")) %>%
  group_by(week_date) %>%
  summarize(caught_weekly = sum(caught_daily)) %>%
  tidyr::complete(week_date = seq.Date(from=min(week_date), to=max(week_date), by='week'), fill=list(caught_weekly=0)) %>%
   mutate(week = as.factor(lubridate::week(week_date)), 
         year = as.factor(lubridate::year(week_date)))

# join climate and trap data
cxr_harmonics_climate_g <- left_join(cxr_harmonics_1_g, weekly_trap_climate_lag, by = c("year" = "year", "week" = "week"))
cxr_harmonics_climate_g <- cxr_harmonics_climate_g %>%
  mutate(log_caught = log(caught_weekly)) 
cxr_harmonics_climate_g$log_caught[is.infinite(cxr_harmonics_climate_g$log_caught)] <- 0


# plot number against time 
ggplot(data = cxr_harmonics_climate_g)+
  geom_line(aes(week_date, caught_weekly))+
  xlab("Time")+
  ylab("Culex restuans caught")+
  theme_classic()

ggplot(data = cxr_harmonics_climate_g)+
  geom_line(aes(week_date, log_caught))+
  ylim(-5, 15)+
  xlab("Time")+
  ylab("Culex caught")+
  theme_classic()

# Fast fourier transform
tmaxb <- length(cxr_harmonics_climate_g$caught_weekly) # number of weeks
dtb <- 1/52 # time step in years
ymb <- abs(fft(cxr_harmonics_climate_g$log_caught)) # absolute value of the power from FFT
fb <- (0:(tmaxb - 1))/tmaxb # frequency of oscillations (in weeks)
periodb <- dtb/fb # period of oscillations (in years) = 1/frequency

plot(x=periodb[2:round(tmaxb/2)+1], y=ymb[2:round(tmaxb/2)+1], 
     type='h', xlim=c(0,12),bty="l",
     xlab='Period (years)', ylab='Strength', 
     main="Absolute value of the power from FFT")

order(ym[2:round(tmax/2)+1], decreasing = T)[1:3] # dominate periods of oscillations --> 19, 20, 40
period[2:round(tmax/2)+1][19] # 1.022115 years
period[2:round(tmax/2)+1][20] # 0.9734432
period[2:round(tmax/2)+1][40] # 0.4985929

######### Dan's method #########
## generate harmonic curves
cxr_harmonics_climate_g <- cxr_harmonics_climate_g %>%
  arrange(week_date) %>%
  mutate(t = row_number())

# dominant periods = 53 weeks (1.022115 years), 51 weeks (0.9734432 years), and
# 26 weeks (0.4985929 years) --> 52/#

cxr_harmonics_climate_2_g <- cxr_harmonics_climate_g %>%
  mutate(sin53 = sin(2*pi*t*0.9783635/52.143), 
         cos53 = cos(2*pi*t*0.97836355/52.143), 
         sin51 = sin(2*pi*t*1.027281/52.143), 
         cos51 = cos(2*pi*t*1.027281/52.143), 
         sin26 = sin(2*pi*t*2/52.143), 
         cos26 = cos(2*pi*t*2/52.143), 
         sin52 = sin(2*pi*t/52.143),
         cos52 = cos(2*pi*t/52.143), 
         sin104 = sin(2*pi*t*0.5/52.143), 
         cos104 = cos(2*pi*t*0.5/52.143))

# just 53 week oscillation
fit1b <- glm.nb(log_caught ~ sin53 + cos53, data = cxr_harmonics_climate_2_g)
cxr_harmonics_climate_2_g$pred1<- fitted(fit1b)

ggplot(cxr_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "gray")+
  geom_line(aes(week_date, pred1), color = "red")+
  theme_classic()

# 52 + 26 week oscillations 
fit2b <- glm.nb(log_caught ~ sin52 + cos52 + sin26 + cos26, data = cxr_harmonics_climate_2_g)
cxr_harmonics_climate_2_g$pred2<- fitted(fit2b)

ggplot(cxr_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred2), color = "red")+
  ylab("Culex restuans caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxr_harmonics_climate_2_g, aes(week_date, exp(log_caught)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred2)), color = "red")+
  ylab("Culex restuans caught")+
  xlab("Time")+
  theme_classic()

# 53 + 51 week oscillations --> doesn't fit well
fit3b <- glm.nb(log_caught ~ sin53 + cos53 + sin51 + cos51, data = cxr_harmonics_climate_2_g)
cxr_harmonics_climate_2_g$pred3<- fitted(fit3b)

ggplot(cxr_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "gray")+
  geom_line(aes(week_date, pred3), color = "red")+
  theme_classic()

# 53, 51, and 26  week oscillations --> doesn't fit well
fit4b <- glm.nb(log_caught ~ sin53 + cos53 + sin51 + cos51 + sin26 + cos26, data = cxr_harmonics_climate_2_g)
cxr_harmonics_climate_2_g$pred4<- fitted(fit4b)

ggplot(cxr_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "gray")+
  geom_line(aes(week_date, pred4), color = "red")+
  theme_classic()

# try just a 52 week oscillation 
fit5b <- glm.nb(log_caught ~ sin52 + cos52, data = cxr_harmonics_climate_2_g)
cxr_harmonics_climate_2_g$pred5<- fitted(fit5b)

ggplot(cxr_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred5), color = "red")+
  ylab("Culex restuans caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxr_harmonics_climate_2_g, aes(week_date, exp(log_caught)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred5)), color = "red")+
  ylab("Culex restuans caught")+
  xlab("Time")+
  theme_classic()

# 52 + 26 + 104 week oscillations 
fit6b <- glm.nb(log_caught ~ sin52 + cos52 + sin26 + cos26 + sin104 + cos104, data = cxr_harmonics_climate_2_g)
cxr_harmonics_climate_2_g$pred6<- fitted(fit6b)

ggplot(cxr_harmonics_climate_2_g, aes(week_date, log_caught))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred6), color = "red")+
  ylab("Culex restuans caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxr_harmonics_climate_2_g, aes(week_date, exp(log_caught)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred6)), color = "red")+
  ylab("Culex restuans caught")+
  xlab("Time")+
  theme_classic()

# determine better model 
AIC(fit1b)
AIC(fit5b)
AIC(fit2b)
AIC(fit6b)
BIC(fit1b)
BIC(fit5b)
BIC(fit2b)#
BIC(fit6b)

### calculate amplitude of 52 week period
# pull coefs out of results of model
beta_sin52b<-coef(fit5b)['sin52']
beta_cos52b<-coef(fit5b)['cos52']

amp52b<-sqrt(beta_sin52b^2 +beta_cos5b2^2)
amp52b # 2.940764

#### run wavelet analysis 
source(file="/Users/zoe/Documents/Yale EMD/Year 1/Quantitative Methods in Infectious Disease Epidemiology/Lab/WaveletPkg.R")
# mozzies caught
wave1b <- cxr_harmonics_climate_2_g %>% 
    mutate(x = sqrt(caught_weekly)) %>% # makes everything behave better and closer to guassian signal
   dplyr::select(x, t)

cwt1b <- complete.cwt(wave1b, dj=1/26, dt=1/52)

plot.cwt(cwt1b) # plots the wavelet with the power spectrum

# precipitation
wave2b <- cxr_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_ppt)) %>%
   dplyr::select(x, t)
cwt2b <- complete.cwt(wave2b, dj=1/26, dt=1/52)
plot.cwt(cwt2b)
# tmin
wave3b <- cxr_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_avg_tmin)) %>% 
   dplyr::select(x, t)
cwt3b <- complete.cwt(wave3b, dj=1/26, dt=1/52)
plot.cwt(cwt3b)
# tmean
wave4b <- cxr_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_avg_tmean)) %>% 
   dplyr::select(x, t)
cwt4b <- complete.cwt(wave4b, dj=1/26, dt=1/52)
plot.cwt(cwt4b)
# tmax
wave5b <- cxr_harmonics_climate_2_g %>% 
    mutate(x=sqrt(weekly_avg_tmax)) %>% 
   dplyr::select(x, t)
cwt5b <- complete.cwt(wave5b, dj=1/26, dt=1/52)
plot.cwt(cwt5b)
# tdmean --> doesn't work
#wave6b <- cxr_harmonics_climate_2 %>% 
#    mutate(x=sqrt(weekly_avg_tdmean)) %>% 
#   dplyr::select(x, t)
#cwt6b <- complete.cwt(wave6b, dj=1/26, dt=1/52)
#plot.cwt(cwt6b)

```

```{r}
#### Calculate Phase angles 
phase1b <- phase(cwt1b, s=c(0.8, 1.2)) # pulls out the phase for whatever period you're looking at
phase2b <- phase(cwt2b, s=c(0.8, 1.2))
phase3b <- phase(cwt3b, s=c(0.8, 1.2))
phase4b <- phase(cwt4b, s=c(0.8, 1.2))
phase5b <- phase(cwt5b, s=c(0.8, 1.2))
#phase6b <- phase(cwt6b, s=c(0.8, 1.2))
	
datesb <- unique(cxr_harmonics_climate_2_g$week_date)
plot(datesb, phase1b,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # cx. restuans
points(datesb, phase2b,type='l', col="light blue", lty=1) # ppt
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

plot(datesb, phase1b,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # cx. restuans
points(datesb, phase3b,type='l', col="pink", lty=1) # tmin
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

plot(datesb, phase1b,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians")
points(datesb, phase4b,type='l', col="orange", lty=1) # tmean
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

plot(datesb, phase1b,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians")
points(datesb, phase5b,type='l', col="goldenrod3", lty=1) # tmax
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

#### Calculate and plot phase differences
#Take modulo (%%) of phase difference to account for edge effects as described by Grenfell. This corrects for problems at start and begining of cycles
phase.diff2.1b= phase2b - phase1b #ppt
phase.diff3.1b = phase3b - phase1b #tmin
phase.diff4.1b = phase4b - phase1b #tmean
phase.diff5.1b = phase5b - phase1b #tmax

phasediff2.1b_correct <- ((phase.diff2.1b + 3*pi) %% (2*pi)) - (pi) #ppt
phasediff3.1b_correct <- ((phase.diff3.1b + 3*pi) %% (2*pi)) - (pi) #tmin
phasediff4.1b_correct <- ((phase.diff4.1b + 3*pi) %% (2*pi)) - (pi) #tmean
phasediff5.1b_correct <- ((phase.diff5.1b + 3*pi) %% (2*pi)) - (pi) #tmax
	#shows corrected phase diff in modulo for the 12 month phase
	# corrects for how things get wonky at the edge of sawtooth (end of each year)

plot(datesb,phasediff2.1b_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #ppt
plot(datesb,phasediff3.1b_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmin
plot(datesb,phasediff4.1b_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmean
plot(datesb,phasediff5.1b_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmax
	
### convert from radians to weeks
#ppt
phase.diff.wk2b <- phasediff2.1b_correct * 52.143/(2*pi)
plot(datesb,phase.diff.wk2b,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

#tmin
phase.diff.wk3b <- phasediff3.1b_correct * 52.143/(2*pi)
plot(datesb,phase.diff.wk3b,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

#tmean
phase.diff.wk4b <- phasediff4.1b_correct * 52.143/(2*pi)
plot(datesb,phase.diff.wk4b,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

#tmax
phase.diff.wk5b <- phasediff5.1b_correct * 52.143/(2*pi)
plot(datesb,phase.diff.wk5b,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesb[105], lty = 6, col = "red")
abline(v = datesb[125], lty = 6, col = "red")
abline(v = datesb[157], lty = 6, col = "red")
abline(v = datesb[175], lty = 6, col = "red")
abline(v = datesb[627], lty = 6, col = "red")
abline(v = datesb[645], lty = 6, col = "red")

```

## Cx. restuans Coherence analysis --> At which periodicity do we have correlation?

```{r coherence}
#ppt
coh1.2b <- complete.coh(wave1b,wave2b, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.2b)

# tmin
coh1.3b <- complete.coh(wave1b,wave3b, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.3b)

# tmean
coh1.4b <- complete.coh(wave1b,wave4b, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.4b)

# tmax
coh1.5b <- complete.coh(wave1b,wave5b, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.5b)


```

### WNV positivity harmonics 
```{r}
####### cx. pipiens #########
cxp_WNV_harmonics_g <- core_traps_ff_surv_g %>%
  filter(Species == "culex pipiens") %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes), 
         total_WNV_daily = sum(WNV_pos)) %>%
  dplyr::select(Date, total_caught_daily, total_WNV_daily) %>%
  group_by(Date) %>%
  dplyr::mutate(caught_daily = sum(total_caught_daily), 
                WNV_daily = sum(total_WNV_daily)) %>%
  distinct(Date, .keep_all = T) %>%
  dplyr::select(Date, caught_daily, WNV_daily) %>%
  group_by(Date) %>%
  mutate(week_date = floor_date(Date, "week")) %>%
  group_by(week_date) %>%
  summarize(caught_weekly = sum(caught_daily), 
            WNV_weekly = sum(WNV_daily)) %>%
  tidyr::complete(week_date = seq.Date(from=min(week_date), to=max(week_date), by='week'), fill=list(caught_weekly=0, WNV_weekly=0)) %>%
   mutate(week = as.factor(lubridate::week(week_date)), 
         year = as.factor(lubridate::year(week_date)), 
         t = row_number())

# join climate and trap data
cxp_WNV_harmonics_climate_g <- left_join(cxp_WNV_harmonics_g, weekly_trap_climate_lag, by = c("year" = "year", "week" = "week"))
cxp_WNV_harmonics_climate_g <- cxp_WNV_harmonics_climate_g %>%
  mutate(log_caught = log(caught_weekly), 
         log_WNV = log(WNV_weekly)) 
cxp_WNV_harmonics_climate_g$log_caught[is.infinite(cxp_WNV_harmonics_climate_g$log_caught)] <- 0
cxp_WNV_harmonics_climate_g$log_WNV[is.infinite(cxp_WNV_harmonics_climate_g$log_WNV)] <- 0  

# plot number against time 
ggplot(data = cxp_WNV_harmonics_climate_g)+
  #geom_line(aes(week_date, caught_weekly), color = "gray")+
  geom_line(aes(week_date, WNV_weekly), color = "navy blue")+
  xlab("Time")+
  ylab("WNV+ Culex pipiens caught")+
  theme_classic()

ggplot(data = cxp_WNV_harmonics_climate_g)+
  geom_line(aes(week_date, log_caught), color = "gray")+
  geom_line(aes(week_date, log_WNV), color = "navy blue")+
  ylim(-1, 15)+
  xlab("Time")+
  ylab("Culex pipiens Caught (log scale)")+
  theme_classic()

# add sin and cos terms
cxp_WNV_harmonics_climate_g <- cxp_WNV_harmonics_climate_g %>%
  mutate(sin26 = sin(2*pi*t*2/52.143), 
         cos26 = cos(2*pi*t*2/52.143), 
         sin52 = sin(2*pi*t/52.143),
         cos52 = cos(2*pi*t/52.143))

# harmonics for WNV positive
wave1c <- cxp_WNV_harmonics_climate_g %>% 
    mutate(x = sqrt(WNV_weekly)) %>% 
   dplyr::select(x, t)

cwt1c <- complete.cwt(wave1c, dj=1/26, dt=1/52)

plot.cwt(cwt1c) 

# precipitation
wave2c <- cxp_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_ppt)) %>%
   dplyr::select(x, t)
cwt2c <- complete.cwt(wave2c, dj=1/26, dt=1/52)
plot.cwt(cwt2c)
# tmin
wave3c <- cxp_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_avg_tmin)) %>% 
   dplyr::select(x, t)
cwt3c <- complete.cwt(wave3c, dj=1/26, dt=1/52)
plot.cwt(cwt3c)
# tmean
wave4c <- cxp_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_avg_tmean)) %>% 
   dplyr::select(x, t)
cwt4c <- complete.cwt(wave4c, dj=1/26, dt=1/52)
plot.cwt(cwt4c)
# tmax
wave5c <- cxp_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_avg_tmax)) %>% 
   dplyr::select(x, t)
cwt5c <- complete.cwt(wave5c, dj=1/26, dt=1/52)
plot.cwt(cwt5c)
#compare to cx. pop
wave6c <- cxp_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(caught_weekly)) %>% 
   dplyr::select(x, t)
cwt6c <- complete.cwt(wave6c, dj=1/26, dt=1/52)


# 52 + 26 week oscillations --> fits best for WNV
fit1c <- glm.nb(log_WNV ~ sin52 + cos52 + sin26 + cos26, data = cxp_WNV_harmonics_climate_g)
cxp_WNV_harmonics_climate_g$pred1<- fitted(fit1c)

ggplot(cxp_WNV_harmonics_climate_g, aes(week_date, log_WNV))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred1), color = "red")+
  ylab("WNV+ Culex pipiens caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxp_WNV_harmonics_climate_g, aes(week_date, exp(log_WNV)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred1)), color = "red")+
  ylab("WNV+ Culex pipiens caught")+
  xlab("Time")+
  theme_classic()

fit3c <- glm.nb(log_WNV ~ sin52 + cos52, data = cxp_WNV_harmonics_climate_g)
cxp_WNV_harmonics_climate_g$pred3<- fitted(fit3c)

AIC(fit1c)
AIC(fit3c)
BIC(fit1c)
BIC(fit3c)

```

```{r}
# calculate phase angles 
phase1c <- phase(cwt1c, s=c(0.8, 1.2))
phase2c <- phase(cwt2c, s=c(0.8, 1.2))
phase3c <- phase(cwt3c, s=c(0.8, 1.2))
phase4c <- phase(cwt4c, s=c(0.8, 1.2))
phase5c <- phase(cwt5c, s=c(0.8, 1.2))
phase6c <- phase(cwt6c, s=c(0.8, 1.2))

# plot phase angles
datesc <- unique(cxp_WNV_harmonics_climate_g$week_date)
plot(datesc, phase1c,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. pipiens
points(datesc, phase2c,type='l', col="light blue", lty=1) # ppt
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

plot(datesc, phase1c,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. pipiens
points(datesc, phase3c,type='l', col="pink", lty=1) # tmin
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

plot(datesc, phase1c,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. pipiens
points(datesc, phase4c,type='l', col="orange", lty=1) # tmean
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

plot(datesc, phase1c,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. pipiens
points(datesc, phase5c,type='l', col="goldenrod3", lty=1) # tmax
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

plot(datesc, phase1c,type='l', col="navy", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. pipiens
points(datesc, phase6c,type='l', col="gray", lty=1) # cx. pipiens
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

#### Calculate and plot phase differences
#Take modulo (%%) of phase difference to account for edge effects as described by Grenfell. This corrects for problems at start and begining of cycles
phase.diff2.1c= phase2c - phase1c #ppt
phase.diff3.1c = phase3c - phase1c #tmin
phase.diff4.1c = phase4c - phase1c #tmean
phase.diff5.1c = phase5c - phase1c #tmax
phase.diff6.1c = phase6c - phase1c #cx. pipiens

phasediff2.1c_correct <- ((phase.diff2.1c+ 3*pi) %% (2*pi)) - (pi) #ppt
phasediff3.1c_correct <- ((phase.diff3.1c + 3*pi) %% (2*pi)) - (pi) #tmin
phasediff4.1c_correct <- ((phase.diff4.1c + 3*pi) %% (2*pi)) - (pi) #tmean
phasediff5.1c_correct <- ((phase.diff5.1c + 3*pi) %% (2*pi)) - (pi) #tmax
phasediff6.1c_correct <- ((phase.diff6.1c + 3*pi) %% (2*pi)) - (pi) #cx. pipiens
	#shows corrected phase diff in modulo for the 12 month phase
	# corrects for how things get wonky at the edge of sawtooth (end of each year)

plot(datesc,phasediff2.1c_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #ppt
plot(datesc,phasediff3.1c_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmin
plot(datesc,phasediff4.1c_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmean
plot(datesc,phasediff5.1c_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmax
plot(datesc,phasediff6.1c_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #cx. pipiens
	
### convert from radians to weeks
#ppt
phase.diff.wk2c <- phasediff2.1c_correct * 52.143/(2*pi)
plot(datesc,phase.diff.wk2c,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

#tmin
phase.diff.wk3c <- phasediff3.1c_correct * 52.143/(2*pi)
plot(datesc,phase.diff.wk3c,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

#tmean
phase.diff.wk4c <- phasediff4.1c_correct * 52.143/(2*pi)
plot(datesc,phase.diff.wk4c,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

#tmax
phase.diff.wk5c <- phasediff5.1c_correct * 52.143/(2*pi)
plot(datesc,phase.diff.wk5c,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

#cx. pipiens
phase.diff.wk6c <- phasediff6.1c_correct * 52.143/(2*pi)
plot(datesc,phase.diff.wk6c,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesc[264], lty = 6, col = "red")
abline(v = datesc[277], lty = 6, col = "red")
abline(v = datesc[317], lty = 6, col = "red")
abline(v = datesc[327], lty = 6, col = "red")
abline(v = datesc[632], lty = 6, col = "red")
abline(v = datesc[644], lty = 6, col = "red")

```


```{r}
####### cx. restuans #########
cxr_WNV_harmonics_g <- core_traps_ff_surv_g %>%
  filter(Species == "culex restuans") %>%
  group_by(Date) %>%
  mutate(total_caught_daily = sum(X..Mosquitoes), 
         total_WNV_daily = sum(WNV_pos)) %>%
  dplyr::select(Date, total_caught_daily, total_WNV_daily) %>%
  group_by(Date) %>%
  dplyr::mutate(caught_daily = sum(total_caught_daily), 
                WNV_daily = sum(total_WNV_daily)) %>%
  distinct(Date, .keep_all = T) %>%
  dplyr::select(Date, caught_daily, WNV_daily) %>%
  group_by(Date) %>%
  mutate(week_date = floor_date(Date, "week")) %>%
  group_by(week_date) %>%
  summarize(caught_weekly = sum(caught_daily), 
            WNV_weekly = sum(WNV_daily)) %>%
  tidyr::complete(week_date = seq.Date(from=min(week_date), to=max(week_date), by='week'), fill=list(caught_weekly=0, WNV_weekly=0)) %>%
   mutate(week = as.factor(lubridate::week(week_date)), 
         year = as.factor(lubridate::year(week_date)), 
         t = row_number())

# join climate and trap data
cxr_WNV_harmonics_climate_g <- left_join(cxr_WNV_harmonics_g, weekly_trap_climate_lag, by = c("year" = "year", "week" = "week"))
cxr_WNV_harmonics_climate_g <- cxr_WNV_harmonics_climate_g %>%
  mutate(log_caught = log(caught_weekly), 
         log_WNV = log(WNV_weekly)) 
cxr_WNV_harmonics_climate_g$log_caught[is.infinite(cxr_WNV_harmonics_climate_g$log_caught)] <- 0
cxr_WNV_harmonics_climate_g$log_WNV[is.infinite(cxr_WNV_harmonics_climate_g$log_WNV)] <- 0  

# plot number against time 
ggplot(data = cxr_WNV_harmonics_climate_g)+
  #geom_line(aes(week_date, caught_weekly), color = "green")+
  geom_line(aes(week_date, WNV_weekly), color = "navy blue")+
  xlab("Time")+
  ylab("WNV+ Culex restuans caught")+
  theme_classic()

ggplot(data = cxr_WNV_harmonics_climate_g)+
  geom_line(aes(week_date, log_caught), color = "gray")+
  geom_line(aes(week_date, log_WNV), color = "navy blue")+
  ylim(-1, 15)+
  xlab("Time")+
  ylab("Culex restuans Caught (log scale)")+
  theme_classic()

# add sin and cos terms
cxr_WNV_harmonics_climate_g <- cxr_WNV_harmonics_climate_g %>%
  mutate(sin26 = sin(2*pi*t*2/52.143), 
         cos26 = cos(2*pi*t*2/52.143), 
         sin52 = sin(2*pi*t/52.143),
         cos52 = cos(2*pi*t/52.143), 
         sin104 = sin(2*pi*t*0.5/52.143), 
         cos104 = cos(2*pi*t*0.5/52.143))


# 52 + 26 week oscillations --> fits best for cx. pipiens population numbers
wave1d <- cxr_WNV_harmonics_climate_g %>% 
    mutate(x = sqrt(WNV_weekly)) %>% 
   dplyr::select(x, t)

cwt1d <- complete.cwt(wave1d, dj=1/26, dt=1/52)

plot.cwt(cwt1d)

# precipitation
wave2d <- cxr_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_ppt)) %>%
   dplyr::select(x, t)
cwt2d <- complete.cwt(wave2d, dj=1/26, dt=1/52)
plot.cwt(cwt2d)
# tmin
wave3d <- cxr_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_avg_tmin)) %>% 
   dplyr::select(x, t)
cwt3d <- complete.cwt(wave3d, dj=1/26, dt=1/52)
plot.cwt(cwt3d)
# tmean
wave4d <- cxr_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_avg_tmean)) %>% 
   dplyr::select(x, t)
cwt4d <- complete.cwt(wave4d, dj=1/26, dt=1/52)
plot.cwt(cwt4d)
# tmax
wave5d <- cxr_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(weekly_avg_tmax)) %>% 
   dplyr::select(x, t)
cwt5d <- complete.cwt(wave5d, dj=1/26, dt=1/52)
plot.cwt(cwt5d)
#compare to cx. pop
wave6d <- cxr_WNV_harmonics_climate_g %>% 
    mutate(x=sqrt(caught_weekly)) %>% 
   dplyr::select(x, t)
cwt6d <- complete.cwt(wave6d, dj=1/26, dt=1/52)

fit2d <- glm.nb(log_caught ~ sin52 + cos52 + sin26 + cos26, data = cxr_WNV_harmonics_climate_g)
cxr_WNV_harmonics_climate_g$pred2<- fitted(fit2c)

ggplot(cxr_WNV_harmonics_climate_g, aes(week_date, log_caught))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred2), color = "red")+
  ylab("Culex restuans caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxr_WNV_harmonics_climate_g, aes(week_date, exp(log_caught)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred2)), color = "red")+
  ylab("Culex restuans caught")+
  xlab("Time")+
  theme_classic()


# 52 + 26 week oscillations --> fits best for WNV
fit1d <- glm.nb(log_WNV ~ sin52 + cos52 + sin26 + cos26, data = cxr_WNV_harmonics_climate_g)
cxr_WNV_harmonics_climate_g$pred1<- fitted(fit1d)

ggplot(cxr_WNV_harmonics_climate_g, aes(week_date, log_WNV))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred1), color = "red")+
  ylab("WNV+ Culex restuans caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxr_WNV_harmonics_climate_g, aes(week_date, exp(log_WNV)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred1)), color = "red")+
  ylab("WNV+ Culex restauns caught")+
  xlab("Time")+
  theme_classic()

fit3d <- glm.nb(log_WNV ~ sin52 + cos52, data = cxr_WNV_harmonics_climate_g)
cxr_WNV_harmonics_climate_g$pred3<- fitted(fit3d)

ggplot(cxr_WNV_harmonics_climate_g, aes(week_date, log_WNV))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, pred3), color = "red")+
  ylab("WNV+ Culex restuans caught (log scale)")+
  xlab("Time")+
  theme_classic()

ggplot(cxr_WNV_harmonics_climate_g, aes(week_date, exp(log_WNV)))+
  geom_line(color = "blue")+
  geom_line(aes(week_date, exp(pred3)), color = "red")+
  ylab("WNV+ Culex restauns caught")+
  xlab("Time")+
  theme_classic()

fit4d <- glm.nb(log_WNV ~ sin52 + cos52 + sin26 + cos26 + sin104 + cos104, data = cxr_WNV_harmonics_climate_g)
cxr_WNV_harmonics_climate_g$pred4<- fitted(fit4d)

AIC(fit1d)
AIC(fit3d)
AIC(fit4d)
BIC(fit1d)
BIC(fit3d)
BIC(fit4d)

```

```{r}
# calculate phase angles 
phase1d <- phase(cwt1d, s=c(0.8, 1.2))
phase2d <- phase(cwt2d, s=c(0.8, 1.2))
phase3d <- phase(cwt3d, s=c(0.8, 1.2))
phase4d <- phase(cwt4d, s=c(0.8, 1.2))
phase5d <- phase(cwt5d, s=c(0.8, 1.2))
phase6d <- phase(cwt6d, s=c(0.8, 1.2))

# plot phase angles
datesd <- unique(cxr_WNV_harmonics_climate_g$week_date)
plot(datesd, phase1d,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. restuans
points(datesd, phase2d,type='l', col="light blue", lty=1) # ppt
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

plot(datesd, phase1d,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. restuans
points(datesd, phase3d,type='l', col="pink", lty=1) # tmin
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

plot(datesd, phase1d,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. restuans
points(datesd, phase4d,type='l', col="orange", lty=1) # tmean
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

plot(datesd, phase1d,type='l', col="black", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. restuans
points(datesd, phase5d,type='l', col="goldenrod3", lty=1) # tmax
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

plot(datesd, phase1d,type='l', col="navy", lty=1, xlab = "Year", ylab = "Radians") # WNV cx. restuans
points(datesd, phase6d,type='l', col="gray", lty=1) # cx. restuans
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

#### Calculate and plot phase differences
#Take modulo (%%) of phase difference to account for edge effects as described by Grenfell. This corrects for problems at start and begining of cycles
phase.diff2.1d= phase2d - phase1d #ppt
phase.diff3.1d = phase3d - phase1d #tmin
phase.diff4.1d = phase4d - phase1d #tmean
phase.diff5.1d = phase5d - phase1d #tmax
phase.diff6.1d = phase6d - phase1d #cx. pipiens

phasediff2.1d_correct <- ((phase.diff2.1d + 3*pi) %% (2*pi)) - (pi) #ppt
phasediff3.1d_correct <- ((phase.diff3.1d + 3*pi) %% (2*pi)) - (pi) #tmin
phasediff4.1d_correct <- ((phase.diff4.1d + 3*pi) %% (2*pi)) - (pi) #tmean
phasediff5.1d_correct <- ((phase.diff5.1d + 3*pi) %% (2*pi)) - (pi) #tmax
phasediff6.1d_correct <- ((phase.diff6.1d + 3*pi) %% (2*pi)) - (pi) #cx. pipiens
	#shows corrected phase diff in modulo for the 12 month phase
	# corrects for how things get wonky at the edge of sawtooth (end of each year)

plot(datesd,phasediff2.1d_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #ppt
plot(datesd,phasediff3.1d_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmin
plot(datesd,phasediff4.1d_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmean
plot(datesd,phasediff5.1d_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #tmax
plot(datesd,phasediff6.1d_correct,type='l',col="blue", lty=1,ylim=c(-pi,pi)) #cx. pipiens
	
### convert from radians to weeks
#ppt
phase.diff.wk2d <- phasediff2.1d_correct * 52.143/(2*pi)
plot(datesd,phase.diff.wk2d,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

#tmin
phase.diff.wk3d <- phasediff3.1d_correct * 52.143/(2*pi)
plot(datesd,phase.diff.wk3d,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

#tmean
phase.diff.wk4d <- phasediff4.1d_correct * 52.143/(2*pi)
plot(datesd,phase.diff.wk4d,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

#tmax
phase.diff.wk5d <- phasediff5.1d_correct * 52.143/(2*pi)
plot(datesd,phase.diff.wk5d,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

#cx. pipiens
phase.diff.wk6d <- phasediff6.1d_correct * 52.143/(2*pi)
plot(datesd,phase.diff.wk6d,type='l',col="blue", lty=1,ylim=c(-26,26), xlab = "Year", ylab = "Phase Difference (weeks)")
abline(h = 0, lty = 3, col = "black")
abline(v = datesd[111], lty = 6, col = "red")
abline(v = datesd[121], lty = 6, col = "red")
abline(v = datesd[268], lty = 6, col = "red")
abline(v = datesd[276], lty = 6, col = "red")
abline(v = datesd[629], lty = 6, col = "red")
abline(v = datesd[645], lty = 6, col = "red")

```


Comparing pipiens and restuans
```{r}

ggplot()+
  geom_line(data = cxp_WNV_harmonics_climate_g, aes(week_date, WNV_weekly), color = "red")+
  geom_line(data = cxr_WNV_harmonics_climate_g, aes(week_date, WNV_weekly), color = "blue")+
  xlab("Time")+
  ylab("WNV+ Culex caught")+
  labs(color = c("Culex pipiens", "Culex resutans"))+
  theme_classic()

```



WNV Coherence
```{r coherence}
##### Cx. pipiens
#ppt
coh1.2c <- complete.coh(wave1c,wave2c, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.2c)

# tmin
coh1.3c <- complete.coh(wave1c,wave3c, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.3c)

# tmean
coh1.4c <- complete.coh(wave1c,wave4c, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.4c)

# tmax
coh1.5c <- complete.coh(wave1c,wave5c, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.5c)

######## Cx. restuans
#ppt
coh1.2d <- complete.coh(wave1d,wave2d, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.2d)

# tmin
coh1.3d <- complete.coh(wave1d,wave3d, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.3d)

# tmean
coh1.4d <- complete.coh(wave1d,wave4d, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.4d)

# tmax
coh1.5d <- complete.coh(wave1d,wave5d, dj=1/26, mc.sim=25) #mc.sim=1000
plot.coh(coh1.5d)

```
